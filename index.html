<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Multiplayer (X-O)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center;}
    .container { margin:40px auto; max-width:350px; background:#fff; padding:25px 15px 35px 15px; border-radius:12px; box-shadow:0 2px 12px #bbb2; }
    .board { display:grid; grid-template-columns:repeat(3,80px); gap:7px; margin:25px auto; justify-content:center;}
    .cell { width:80px; height:80px; background:#f4f8fa; border-radius:7px; font-size:2.5em; cursor:pointer; line-height:80px; transition:background .2s; user-select:none; border:2px solid #b4c6d8;}
    .cell:hover { background:#e8edf3;}
    .btn-block{display:block;width:100%;margin:8px 0;padding:10px 22px;font-size:1em;border:none;border-radius:8px;background:#3775dd;color:#fff;cursor:pointer;transition:background .2s;}
    .btn-block:hover{background:#285bb5;}
    .status{font-size:1.2em;margin:13px 0 3px 0;font-weight:bold;}
    .link {margin:12px 0; color:#3775dd; font-size:1em;}
    .me {color:#2db312; font-weight:bold;}
    .wait {color:#c19700;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Tic Tac Toe Multiplayer (X-O)</h1>
    <div id="main-menu">
      <button class="btn-block" onclick="startLocal()">Lokal (bitta qurilmada)</button>
      <button class="btn-block" onclick="startOnline()">Doâ€˜st bilan onlayn</button>
    </div>
    <div id="game" style="display:none;">
      <div class="status" id="status"></div>
      <div class="board" id="board"></div>
      <button class="btn-block" id="restartBtn" style="display:none;" onclick="restartGame()">Qayta oâ€˜ynash</button>
      <div id="share-block" class="link"></div>
      <button class="btn-block" style="margin-top:10px;" onclick="backToMenu()">Ortga</button>
    </div>
  </div>
  <!-- Socket.io klient kutubxonasi -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // === SOZLAMALAR ===
    // Backend URL'niz shu:
    const backendUrl = "https://tictactoebackend-eh25.onrender.com";

    // === O'zgaruvchilar ===
    let mode = null; // "local" yoki "online"
    let board = Array(9).fill(null);
    let turn = "X";
    let winner = null;
    let mySymbol = null;
    let oppSymbol = null;
    let gameId = null;
    let socket = null;
    let isMyTurn = true;

    // === DOM elementi ===
    const mainMenu = document.getElementById("main-menu");
    const gameDiv = document.getElementById("game");
    const statusDiv = document.getElementById("status");
    const boardDiv = document.getElementById("board");
    const restartBtn = document.getElementById("restartBtn");
    const shareBlock = document.getElementById("share-block");

    // === Funksiyalar ===
    function startLocal() {
      mode = "local";
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      mySymbol = null;
      oppSymbol = null;
      isMyTurn = true;
      mainMenu.style.display = "none";
      shareBlock.innerHTML = "";
      gameDiv.style.display = "";
      renderBoard();
      updateStatus();
      restartBtn.style.display = "none";
    }

    function startOnline() {
      // O'yin xonasi ID'sini yaratish yoki olish
      let q = new URLSearchParams(location.search);
      gameId = q.get("game");
      if (!gameId) {
        // O'yin yaratuvchi ("X")
        gameId = Math.random().toString(36).slice(2,10);
        mySymbol = "X";
        oppSymbol = "O";
        isMyTurn = true;
        history.replaceState({}, '', '?game=' + gameId);
        showShareLink();
      } else {
        // O'yinga kiruvchi ("O")
        mySymbol = "O";
        oppSymbol = "X";
        isMyTurn = false;
      }
      mode = "online";
      mainMenu.style.display = "none";
      gameDiv.style.display = "";
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      restartBtn.style.display = "none";
      renderBoard();
      updateStatus();
      connectSocket();
    }

    function showShareLink() {
      shareBlock.innerHTML = `Ushbu havolani doâ€˜stingizga yuboring: <br>
        <input style="width:85%;text-align:center;" readonly value="${location.href}"><br>
        <span class="wait">Doâ€˜stingiz kirishini kuting...</span>`;
    }

    function connectSocket() {
      socket = io(backendUrl);
      socket.on("connect", () => {
        socket.emit("join", gameId);
      });
      socket.on("state", (game) => {
        board = game.board;
        turn = game.turn;
        winner = game.winner;
        renderBoard();
        updateStatus();
        if (winner) restartBtn.style.display = "";
      });
      socket.on("player-joined", () => {
        if (mySymbol === "X") {
          shareBlock.innerHTML = '<span class="me">Doâ€˜stingiz ulandi! Oâ€˜yin boshlandi.</span>';
        }
      });
      socket.on("disconnect", () => {
        statusDiv.textContent = "Server bilan aloqa uzildi. Qayta urinilmoqda...";
      });
    }

    function move(idx) {
      if (board[idx] || winner) return;
      if (mode === "local") {
        board[idx] = turn;
        winner = checkWinner();
        turn = turn === "X" ? "O" : "X";
        renderBoard();
        updateStatus();
        if (winner) restartBtn.style.display = "";
      } else if (mode === "online") {
        if ((mySymbol !== turn) || winner) return;
        socket.emit("move", { gameId, idx, player: mySymbol });
      }
    }

    function renderBoard() {
      boardDiv.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        boardDiv.innerHTML += `<div class="cell" onclick="move(${i})">${board[i] ? board[i] : ''}</div>`;
      }
    }

    function updateStatus() {
      if (mode === "local") {
        if (winner)
          statusDiv.textContent = winner === "draw" ? "Durrang!" : `Gâ€˜olib: ${winner}`;
        else
          statusDiv.textContent = `Navbat: ${turn}`;
      } else if (mode === "online") {
        if (!mySymbol) return;
        if (winner) {
          if (winner === "draw") {
            statusDiv.textContent = "Durrang!";
          } else if (winner === mySymbol) {
            statusDiv.textContent = "Siz gâ€˜olibsiz! ðŸŽ‰";
          } else {
            statusDiv.textContent = "Doâ€˜stingiz gâ€˜olib!";
          }
        } else if (turn === mySymbol) {
          statusDiv.innerHTML = 'Sizning navbatingiz <span class="me">(' + mySymbol + ')</span>';
        } else {
          statusDiv.innerHTML = 'Doâ€˜stingiz harakati <span class="wait">(' + oppSymbol + ')</span>';
        }
      }
    }

    function checkWinner() {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let l of lines) {
        const [a,b,c] = l;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      if (board.every(Boolean)) return 'draw';
      return null;
    }

    function restartGame() {
      if (mode === "local") {
        board = Array(9).fill(null);
        turn = "X";
        winner = null;
        renderBoard();
        updateStatus();
        restartBtn.style.display = "none";
      } else if (mode === "online" && socket) {
        socket.emit("restart", gameId);
      }
    }

    function backToMenu() {
      if (mode === "online" && socket) {
        socket.emit("leave", gameId);
        socket.disconnect();
      }
      mode = null;
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      mySymbol = null;
      oppSymbol = null;
      gameId = null;
      history.replaceState({}, '', location.pathname);
      mainMenu.style.display = "";
      gameDiv.style.display = "none";
      shareBlock.innerHTML = "";
    }

    // Agar URLâ€™da ?game=... boâ€˜lsa, avtomatik multiplayerga kirish
    window.onload = function() {
      let q = new URLSearchParams(location.search);
      if (q.get("game")) startOnline();
    }
  </script>
</body>
</html>
