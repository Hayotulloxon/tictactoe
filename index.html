<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Multiplayer & AI (X-O)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --main-blue: #3775dd;
      --main-pink: #fa5a72;
      --main-green: #1fa960;
      --main-yellow: #ffe68a;
      --main-bg1: #e3eefe;
      --main-bg2: #efddfb;
      --cell-shadow: 0 2px 12px #bdd7ff55;
      --panel-shadow: 0 6px 36px #bdd7ff60, 0 1.5px 6px #0002;
    }
    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: linear-gradient(135deg, var(--main-bg1) 0%, var(--main-bg2) 100%);
      min-height: 100vh;
      margin: 0;
      overflow-x: hidden;
    }
    .container {
      margin: 5vw auto;
      max-width: 410px;
      background: #fff;
      padding: 34px 18px 40px 18px;
      border-radius: 22px;
      box-shadow: var(--panel-shadow);
      position: relative;
      z-index: 1;
    }
    h1 {
      letter-spacing: 1.5px;
      color: var(--main-blue);
      margin-top: 0;
      margin-bottom: 18px;
      font-size: 2.2em;
      font-weight: 700;
      background: linear-gradient(90deg, var(--main-blue) 60%, var(--main-pink) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .menu-btns { margin-bottom: 12px;}
    .btn-block {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 15px 0;
      font-size: 1.12em;
      font-weight: 500;
      border: none;
      border-radius: 11px;
      background: linear-gradient(90deg, var(--main-blue) 60%, var(--main-pink) 100%);
      color: #fff;
      box-shadow: 0 1px 5px #3775dd20;
      cursor: pointer;
      letter-spacing: 0.5px;
      transition: background .18s, box-shadow .18s, transform .13s;
    }
    .btn-block:hover, #copyBtn:hover { 
      background: linear-gradient(90deg, var(--main-pink) 30%, var(--main-blue) 100%);
      transform: translateY(-1px) scale(1.025);
      box-shadow: 0 4px 16px #d2e3ff40;
    }
    #copyBtn {
      display:inline-block;
      margin-left:5px;
      padding:4px 16px;
      font-size:1em;
      border:none;
      border-radius:7px;
      background:linear-gradient(90deg,var(--main-blue) 60%,var(--main-pink) 100%);
      color:#fff; cursor:pointer;
      transition:background .17s, box-shadow .17s;
    }
    #copyBtn.copied {
      background:linear-gradient(90deg,var(--main-green) 60%,#64e39f 100%);
      color:#fff;
      box-shadow: 0 0 8px #b6e5cd60;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 86px);
      gap: 12px;
      margin: 32px auto 10px auto;
      justify-content: center;
      position: relative;
    }
    .cell {
      width: 86px; height: 86px;
      background: #f5f9ff;
      border-radius: 17px;
      font-size: 2.7em;
      font-weight: bold;
      color: var(--main-blue);
      cursor: pointer;
      line-height: 86px;
      box-shadow: var(--cell-shadow);
      user-select: none;
      border: 2.5px solid #b4c6d8;
      transition: background .17s, color .14s, box-shadow .13s, border-color .13s, transform .13s;
      text-align:center;
      outline: none;
      position: relative;
      z-index: 2;
      overflow: visible;
    }
    .cell:hover { background:#e9f1ff; border-color: var(--main-blue);}
    .cell.x { color: var(--main-blue);}
    .cell.o { color: var(--main-pink);}
    .cell.win { 
      background: var(--main-yellow); 
      color: var(--main-green); 
      border-color: var(--main-green); 
      animation: winPop .38s cubic-bezier(.12,1.32,.91,1.05) both;
      box-shadow: 0 0 26px #ffe68a85,0 2px 12px #bdd7ff55;
    }
    .cell.animated { animation: movePop .24s cubic-bezier(.17,1.74,.53,.98) both;}
    @keyframes movePop {
      0% { transform: scale(.2) rotate(-20deg); filter:blur(2px);}
      50% {transform: scale(1.15) rotate(8deg);}
      100% {transform: scale(1) rotate(0deg);}
    }
    @keyframes winPop {
      0% { box-shadow: 0 0 0 #ffe68a00;  }
      60% { box-shadow: 0 0 28px #ffe68a85,0 2px 12px #bdd7ff55;}
      100% { box-shadow: 0 0 26px #ffe68a85,0 2px 12px #bdd7ff55;}
    }
    .confetti {
      pointer-events:none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh;
      z-index: 9999;
      overflow: visible;
      pointer-events:none;
    }
    .status {
      font-size: 1.18em;
      margin: 15px 0 8px 0;
      font-weight: bold;
      letter-spacing: .5px;
      min-height: 20px;
      color: #333;
      text-shadow: 0 1px 0 #fff2;
      text-align:center;
    }
    .status .me {
      color:var(--main-green); font-weight:bold;
    }
    .status .wait {
      color:var(--main-pink); font-weight:bold;
    }
    .link {margin:13px 0; color: var(--main-blue); font-size:1em;}
    .me {color:var(--main-green); font-weight:bold;}
    .wait {color:var(--main-pink);}
    input[type="text"], input[type="url"] {
      font-size: 1em;
      padding: 7px 14px;
      border-radius: 7px;
      border: 1.5px solid #b4c6d8;
      width: 72%;
      margin-bottom: 6px;
      outline: none;
      background: #f9fbff;
      text-align: center;
      transition: border-color .15s;
    }
    input[type="text"]:focus { border-color: var(--main-blue);}
    .footer {
      margin: 22px 0 0 0;
      color: #b7b7b7;
      font-size: .98em;
      letter-spacing: 0.2px;
      text-align: center;
      opacity: 0.95;
    }
    @media (max-width:500px) {
      .container {max-width: 98vw; padding: 7vw 2vw 30vw 2vw;}
      .board { grid-template-columns: repeat(3, 25vw); gap: 2vw;}
      .cell { width: 25vw; height: 25vw; font-size: 8vw; line-height: 25vw;}
    }
    /* Confetti pieces */
    .confetti-piece {
      position: absolute;
      width: 10px; height: 18px;
      border-radius: 3px;
      opacity: 0.8;
      will-change: transform;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Tic Tac Toe <span style="font-size:.75em;">(X-O)</span></h1>
    <div id="main-menu">
      <div class="menu-btns">
        <button class="btn-block" onclick="startLocal()">Lokal (bitta qurilmada)</button>
        <button class="btn-block" onclick="startOnline()">Doâ€˜st bilan onlayn</button>
        <button class="btn-block" onclick="startAI()">AI (bot) bilan oâ€˜ynash</button>
      </div>
    </div>
    <div id="game" style="display:none;">
      <div class="status" id="status"></div>
      <div class="board" id="board"></div>
      <button class="btn-block" id="restartBtn" style="display:none;" onclick="restartGame()">Qayta oâ€˜ynash</button>
      <div id="share-block" class="link"></div>
      <button class="btn-block" style="margin-top:10px;" onclick="backToMenu()">Ortga</button>
    </div>
    <div class="footer">Â© <span id="year"></span> Tic Tac Toe | Hayotulloxon uchun maxsus</div>
    <div class="confetti" id="confetti"></div>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const backendUrl = "https://tictactoebackend-eh25.onrender.com";
    let mode = null;
    let board = Array(9).fill(null);
    let turn = "X";
    let winner = null;
    let mySymbol = null;
    let oppSymbol = null;
    let gameId = null;
    let socket = null;
    let aiSymbol = null;
    let humanSymbol = null;
    let isHumanFirst = false;
    let lastWinLine = [];
    let aiName = "ðŸ¤– Bot";
    const mainMenu = document.getElementById("main-menu");
    const gameDiv = document.getElementById("game");
    const statusDiv = document.getElementById("status");
    const boardDiv = document.getElementById("board");
    const restartBtn = document.getElementById("restartBtn");
    const shareBlock = document.getElementById("share-block");
    const confettiDiv = document.getElementById("confetti");

    function startLocal() {
      mode = "local";
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      mySymbol = null;
      oppSymbol = null;
      lastWinLine = [];
      mainMenu.style.display = "none";
      shareBlock.innerHTML = "";
      gameDiv.style.display = "";
      renderBoard();
      updateStatus();
      restartBtn.style.display = "none";
      clearConfetti();
    }

    function startOnline() {
      let q = new URLSearchParams(location.search);
      gameId = q.get("game");
      let first = "X";
      if (!gameId) {
        gameId = Math.random().toString(36).slice(2,10);
        mySymbol = first;
        oppSymbol = first === "X" ? "O" : "X";
        history.replaceState({}, '', '?game=' + gameId);
        showShareLink();
      } else {
        mySymbol = "O";
        oppSymbol = "X";
      }
      mode = "online";
      mainMenu.style.display = "none";
      gameDiv.style.display = "";
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      lastWinLine = [];
      restartBtn.style.display = "none";
      renderBoard();
      updateStatus();
      connectSocket();
      clearConfetti();
    }

    function startAI() {
      mode = "ai";
      board = Array(9).fill(null);
      winner = null;
      if (isHumanFirst) {
        humanSymbol = "X";
        aiSymbol = "O";
        turn = "X";
      } else {
        humanSymbol = "O";
        aiSymbol = "X";
        turn = "X";
      }
      lastWinLine = [];
      mainMenu.style.display = "none";
      shareBlock.innerHTML = "";
      gameDiv.style.display = "";
      renderBoard();
      updateStatus();
      restartBtn.style.display = "none";
      clearConfetti();
      if (turn === aiSymbol) setTimeout(aiMove, 500);
    }

    function showShareLink() {
      shareBlock.innerHTML = `Ushbu havolani doâ€˜stingizga yuboring:<br>
        <input id="shareInput" type="text" readonly value="${location.href}">
        <button id="copyBtn" onclick="copyShareLink()">Nusxalash</button><br>
        <span class="wait">Doâ€˜stingiz kirishini kuting...</span>`;
    }

    function copyShareLink() {
      const input = document.getElementById("shareInput");
      input.select();
      input.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(input.value).then(()=>{
        const btn = document.getElementById("copyBtn");
        btn.textContent = "Nusxalandi!";
        btn.classList.add("copied");
        setTimeout(()=>{
          btn.textContent = "Nusxalash";
          btn.classList.remove("copied");
        }, 1300);
      });
    }

    function connectSocket() {
      socket = io(backendUrl);
      socket.on("connect", () => {
        socket.emit("join", gameId);
      });
      socket.on("state", (game) => {
        board = game.board;
        turn = game.turn;
        winner = game.winner;
        lastWinLine = findWinLine(board);
        renderBoard();
        updateStatus();
        if (winner) restartBtn.style.display = "";
        if (winner && lastWinLine.length > 0) fireConfetti();
      });
      socket.on("player-joined", () => {
        if (mySymbol === "X") {
          shareBlock.innerHTML = '<span class="me">Doâ€˜stingiz ulandi! Oâ€˜yin boshlandi.</span>';
        }
      });
      socket.on("disconnect", () => {
        statusDiv.textContent = "Server bilan aloqa uzildi. Qayta urinilmoqda...";
      });
    }

    function move(idx) {
      if (board[idx] || winner) return;
      if (mode === "local") {
        board[idx] = turn;
        winner = checkWinner();
        lastWinLine = findWinLine(board);
        animateCell(idx);
        turn = turn === "X" ? "O" : "X";
        renderBoard();
        updateStatus();
        if (winner) {
          restartBtn.style.display = "";
          if (lastWinLine.length > 0) fireConfetti();
        }
      } else if (mode === "online") {
        if ((mySymbol !== turn) || winner) return;
        socket.emit("move", { gameId, idx, player: mySymbol });
      } else if (mode === "ai") {
        if (turn !== humanSymbol || winner) return;
        board[idx] = humanSymbol;
        winner = checkWinner();
        lastWinLine = findWinLine(board);
        animateCell(idx);
        turn = aiSymbol;
        renderBoard();
        updateStatus();
        if (winner) {
          restartBtn.style.display = "";
          if (lastWinLine.length > 0) fireConfetti();
        }
        else setTimeout(aiMove, 500);
      }
    }

    function renderBoard() {
      boardDiv.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        let c = "cell";
        if (board[i]) c += " " + board[i].toLowerCase();
        if (lastWinLine.includes(i)) c += " win";
        boardDiv.innerHTML += `<div class="${c}" id="cell${i}" onclick="move(${i})">${board[i] ? board[i] : ''}</div>`;
      }
    }

    function updateStatus() {
      if (mode === "local") {
        if (winner)
          statusDiv.textContent = winner === "draw" ? "Durrang!" : `Gâ€˜olib: ${winner}`;
        else
          statusDiv.textContent = `Navbat: ${turn}`;
      } else if (mode === "online") {
        if (!mySymbol) return;
        if (winner) {
          if (winner === "draw") {
            statusDiv.textContent = "Durrang!";
          } else if (winner === mySymbol) {
            statusDiv.textContent = "Siz gâ€˜olibsiz! ðŸŽ‰";
          } else {
            statusDiv.textContent = "Doâ€˜stingiz gâ€˜olib!";
          }
        } else if (turn === mySymbol) {
          statusDiv.innerHTML = 'Sizning navbatingiz <span class="me">(' + mySymbol + ')</span>';
        } else {
          statusDiv.innerHTML = 'Doâ€˜stingiz harakati <span class="wait">(' + oppSymbol + ')</span>';
        }
      } else if (mode === "ai") {
        if (winner) {
          if (winner === humanSymbol) {
            statusDiv.textContent = "Siz yutdingiz! ðŸŽ‰";
          } else if (winner === aiSymbol) {
            statusDiv.textContent = aiName + " yutdi!";
          } else {
            statusDiv.textContent = "Durrang!";
          }
        } else if (turn === humanSymbol) {
          statusDiv.textContent = "Sizning navbatingiz";
        } else {
          statusDiv.textContent = aiName + " navbati...";
        }
      }
    }

    function checkWinner() {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let l of lines) {
        const [a,b,c] = l;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      if (board.every(Boolean)) return 'draw';
      return null;
    }

    function findWinLine(b) {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let l of lines) {
        const [a,b,c] = l;
        if (b[a] && b[a] === b[b] && b[a] === b[c]) return l;
      }
      return [];
    }

    function restartGame() {
      if (mode === "local") {
        board = Array(9).fill(null);
        turn = "X";
        winner = null;
        lastWinLine = [];
        renderBoard();
        updateStatus();
        restartBtn.style.display = "none";
        clearConfetti();
      } else if (mode === "online" && socket) {
        socket.emit("restart", gameId);
        clearConfetti();
      } else if (mode === "ai") {
        isHumanFirst = !isHumanFirst;
        board = Array(9).fill(null);
        winner = null;
        if (isHumanFirst) {
          humanSymbol = "X";
          aiSymbol = "O";
          turn = "X";
        } else {
          humanSymbol = "O";
          aiSymbol = "X";
          turn = "X";
        }
        lastWinLine = [];
        renderBoard();
        updateStatus();
        restartBtn.style.display = "none";
        clearConfetti();
        if (turn === aiSymbol) setTimeout(aiMove, 500);
      }
    }

    function backToMenu() {
      if (mode === "online" && socket) {
        socket.emit("leave", gameId);
        socket.disconnect();
      }
      mode = null;
      board = Array(9).fill(null);
      turn = "X";
      winner = null;
      mySymbol = null;
      oppSymbol = null;
      gameId = null;
      lastWinLine = [];
      history.replaceState({}, '', location.pathname);
      mainMenu.style.display = "";
      gameDiv.style.display = "none";
      shareBlock.innerHTML = "";
      isHumanFirst = false; // menyuga chiqsangiz default: bot birinchi
      clearConfetti();
    }

    function aiMove() {
      if (winner || turn !== aiSymbol) return;
      let moveIdx = findBestMove(board, aiSymbol, humanSymbol);
      if (moveIdx === -1) {
        let empties = board.map((v, i) => v ? null : i).filter(v => v !== null);
        moveIdx = empties[Math.floor(Math.random() * empties.length)];
      }
      board[moveIdx] = aiSymbol;
      winner = checkWinner();
      lastWinLine = findWinLine(board);
      animateCell(moveIdx);
      turn = humanSymbol;
      renderBoard();
      updateStatus();
      if (winner) {
        restartBtn.style.display = "";
        if (lastWinLine.length > 0) fireConfetti();
      }
      if (!winner && turn === aiSymbol) setTimeout(aiMove, 500);
    }

    function findBestMove(b, ai, human) {
      for (let i = 0; i < 9; i++) {
        if (!b[i]) {
          b[i] = ai;
          if (checkWinner() === ai) { b[i] = null; return i; }
          b[i] = null;
        }
      }
      for (let i = 0; i < 9; i++) {
        if (!b[i]) {
          b[i] = human;
          if (checkWinner() === human) { b[i] = null; return i; }
          b[i] = null;
        }
      }
      if (!b[4]) return 4;
      return -1;
    }

    function animateCell(idx) {
      setTimeout(() => {
        const cell = document.getElementById("cell" + idx);
        if (cell) {
          cell.classList.remove("animated");
          void cell.offsetWidth;
          cell.classList.add("animated");
        }
      }, 10);
    }

    function fireConfetti() {
      clearConfetti();
      const colors = [
        "var(--main-blue)", "var(--main-pink)", "var(--main-green)", "#ffd700", "#f7971e", "#7c77b9"
      ];
      const pieces = 46;
      for(let i=0;i<pieces;i++) {
        let conf = document.createElement("div");
        conf.className = "confetti-piece";
        conf.style.background = colors[Math.floor(Math.random()*colors.length)];
        conf.style.left = (Math.random()*100) + "vw";
        conf.style.top = "-4vh";
        conf.style.opacity = Math.random()*0.6 + 0.4;
        conf.style.transform = `rotate(${Math.random()*360}deg)`;
        confettiDiv.appendChild(conf);
        const fall = 60 + Math.random()*30;
        const transX = (Math.random()-.5)*30;
        setTimeout(() => {
          conf.style.transition = "top 1.6s cubic-bezier(.3,.4,.47,1.2), left 1.6s cubic-bezier(.3,.4,.47,1.2), opacity 2s";
          conf.style.top = fall + "vh";
          conf.style.left = `calc(${conf.style.left} + ${transX}vw)`;
          conf.style.opacity = 0;
        }, 20+Math.random()*150);
      }
      setTimeout(clearConfetti, 2600);
    }
    function clearConfetti() {
      confettiDiv.innerHTML = "";
    }

    window.onload = function() {
      let q = new URLSearchParams(location.search);
      if (q.get("game")) startOnline();
      document.getElementById("year").textContent = new Date().getFullYear();
    }
  </script>
</body>
</html>
