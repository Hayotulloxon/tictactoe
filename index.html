<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Tic Tac Toe Multiplayer (Firebase)</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; text-align: center;}
    .container { margin:40px auto; max-width:350px; background:#fff; padding:25px 15px 35px 15px; border-radius:12px; box-shadow:0 2px 12px #bbb2; }
    .board { display:grid; grid-template-columns:repeat(3,80px); gap:7px; margin:25px auto; justify-content:center;}
    .cell { width:80px; height:80px; background:#f4f8fa; border-radius:7px; font-size:2.5em; cursor:pointer; line-height:80px; transition:background .2s; user-select:none; border:2px solid #b4c6d8;}
    .cell:hover { background:#e8edf3;}
    .btn-block{display:block;width:100%;margin:8px 0;padding:10px 22px;font-size:1em;border:none;border-radius:8px;background:#3775dd;color:#fff;cursor:pointer;transition:background .2s;text-align:center;}
    .btn-block:hover{background:#285bb5;}
    .invite-section{margin:18px 0;background:#eaf6ff;padding:10px;border-radius:8px;}
    input[type="text"]{width:95%;font-size:1em;padding:5px;border-radius:5px;border:1px solid #b4c6d8;}
    .status{font-size:1.2em;margin:13px 0 3px 0;font-weight:bold;}
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <div class="container" id="main"></div>
  <script>
    // 1. FIREBASE CONFIG: mana bu yerga o'zingizning Firebase config-ni qo'ying!
    const firebaseConfig = {
      apiKey: "YOUR_FIREBASE_API_KEY",
      authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
      databaseURL: "YOUR_FIREBASE_DATABASE_URL",
      projectId: "YOUR_FIREBASE_PROJECT_ID",
      storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let board, turn, winner, mode, gameId = null, playerSymbol = null, roomRef = null, joined = false;

    function renderHome() {
      document.getElementById('main').innerHTML = `
        <h1>Tic Tac Toe (X-O)</h1>
        <button class="btn-block" onclick="createGame()">Do‘st bilan multiplayer o‘ynash</button>
        <button class="btn-block" onclick="location.reload()">Yakka rejim (AI) uchun eski koddan foydalaning</button>
      `;
    }

    function createGame() {
      gameId = Math.random().toString(36).substr(2, 8);
      playerSymbol = "X";
      // Firebase room yaratish
      board = [null,null,null,null,null,null,null,null,null];
      turn = "X";
      winner = null;
      db.ref("games/"+gameId).set({
        board, turn, winner, created: Date.now()
      });
      let joinUrl = `${location.origin}${location.pathname}?game=${gameId}`;
      document.getElementById('main').innerHTML = `
        <h2>Do‘stni o‘yin uchun taklif qiling</h2>
        <div class="invite-section">
          <input type="text" id="inviteLink" value="${joinUrl}" readonly><br>
          <button class="btn-block" onclick="copyInvite()">Havolani nusxalash</button>
        </div>
        <button class="btn-block" onclick="joinGame('${gameId}')">O‘yin sahifasiga o‘tish</button>
        <button class="btn-block" onclick="renderHome()">Ortga</button>
      `;
    }

    function copyInvite(){
      let inp = document.getElementById('inviteLink');
      inp.select();
      inp.setSelectionRange(0, 99999);
      document.execCommand('copy');
      alert("Havola nusxalandi!");
    }

    function joinGame(id) {
      gameId = id;
      playerSymbol = "O";
      startMultiplayer();
    }

    function renderGame() {
      let btns = `
        <button class="btn-block" onclick="restartGame()">Qayta o‘ynash</button>
        <button class="btn-block" onclick="leaveGame()">O‘yin tugatish</button>
      `;
      document.getElementById('main').innerHTML = `
        <h2>Tic Tac Toe - Multiplayer</h2>
        <div class="status" id="status"></div>
        <div class="board" id="board"></div>
        ${btns}
        <div style="font-size:0.97em;margin-top:8px;opacity:0.7">
          Siz: <b>${playerSymbol ? playerSymbol : "?"}</b> &nbsp; | &nbsp; O‘yin kodi: <b>${gameId}</b>
        </div>
      `;
      const boardDiv = document.getElementById('board');
      boardDiv.innerHTML = '';
      for (let i = 0; i < 9; i++) {
        boardDiv.innerHTML += `<div class="cell" onclick="move(${i})">${board[i] ? board[i] : ''}</div>`;
      }
      updateStatus();
    }

    function move(idx){
      if(winner || board[idx] || turn !== playerSymbol) return;
      board[idx] = playerSymbol;
      turn = playerSymbol === "X" ? "O" : "X";
      winner = checkWinner();
      // Natijani Firebase-ga yozamiz
      db.ref("games/"+gameId).update({ board, turn, winner });
    }

    function restartGame(){
      if (!gameId) return;
      // Faqat X boshlaydi, navbat o'zgarmaydi
      board = [null,null,null,null,null,null,null,null,null];
      turn = "X";
      winner = null;
      db.ref("games/"+gameId).update({ board, turn, winner });
    }

    function leaveGame() {
      if (gameId) db.ref("games/"+gameId).remove();
      gameId = null;
      playerSymbol = null;
      if (roomRef) roomRef.off();
      renderHome();
    }

    function updateStatus(){
      let statusDiv = document.getElementById('status');
      if(winner)
        statusDiv.textContent = winner === 'draw' ? 'Durrang!' : `G‘olib: ${winner}`;
      else if (turn === playerSymbol)
        statusDiv.textContent = "Sizning navbatingiz!";
      else
        statusDiv.textContent = "Do‘stning navbati...";
    }

    function checkWinner(){
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let l of lines) {
        const [a,b,c] = l;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      if (board.every(Boolean)) return 'draw';
      return null;
    }

    // --- Multiplayer boshlanishi va sinxronizatsiya ---
    function startMultiplayer() {
      mode = 'friend';
      winner = null;
      board = [null,null,null,null,null,null,null,null,null];
      turn = "X";
      // X o‘yinchi (yaratuvchi) bo‘lsa - X, boshqa kishi 'O'
      if (!playerSymbol) playerSymbol = "O";
      renderGame();
      // Firebase listener
      if (roomRef) roomRef.off(); // eski listener o‘chiriladi
      roomRef = db.ref("games/"+gameId);
      roomRef.on('value', (snap) => {
        let data = snap.val();
        if (!data) {
          alert("O‘yin tugadi yoki mavjud emas.");
          leaveGame();
          return;
        }
        board = data.board;
        turn = data.turn;
        winner = data.winner;
        renderGame();
      });
    }

    // URLdan gameId bo‘lsa, multiplayerga ulash
    window.onload = function() {
      const params = new URLSearchParams(location.search);
      if (params.has('game')) {
        gameId = params.get('game');
        playerSymbol = "O";
        startMultiplayer();
      } else {
        renderHome();
      }
    }
  </script>
</body>
</html>
